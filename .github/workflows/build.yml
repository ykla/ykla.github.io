name: ğŸ”— æ„å»º pkgbase

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1,9,17 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pkgbase
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - amd64
#          - aarch64
#          - riscv64

    steps:
      - name: æ£€å‡º
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: åˆå§‹åŒ–è¾“å‡ºç›®å½• (${{ matrix.target }})
        run: |
          mkdir -p pages-root

      - name: åœ¨ FreeBSD VM ä¸­æ„å»º (${{ matrix.target }})
        uses: vmactions/freebsd-vm@v1.4.2
        with:
          release: "15.0"
          arch: x86_64
          sync-time: true
          mem: 8192
#          debug-on-error: true
          run: |
            TARGET_ARCH=${{ matrix.target }}
            pkg update -f  # æ³¨æ„ï¼Œriscv é»˜è®¤æ—  pkg æº
            pkg ins -y git 
            cd /usr/src
            git init
            git remote add origin https://github.com/freebsd/freebsd-src.git
            git fetch
            git checkout main

            case "$TARGET_ARCH" in
              amd64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/amd64/conf/GENERIC || true
                ;;
              aarch64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/arm64/conf/std.arm64 || true
                ;;
              riscv64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/riscv/conf/GENERIC || true
                ;;
            esac

            make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH buildworld
            make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH buildkernel
            make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH packages
            # ç›´æ¥å¤åˆ¶åˆ° pages-root
            mkdir -p /home/runner/work/ykla.github.io/ykla.github.io/pages-root 
            TZ=Asia/Shanghai git log -1 --pretty=format:"å“ˆå¸Œï¼š%H%nä½œè€…ï¼š%an <%ae>%næäº¤è€…ï¼š%cn <%ce>%næäº¤æ—¶é—´ï¼š%cd%næäº¤ä¿¡æ¯ï¼š%n%n%B" --date=format:"%Y-%m-%d %H:%M:%S %z" > /home/runner/work/ykla.github.io/ykla.github.io/pages-root/githead.txt

            for d in /usr/obj/usr/src/repo/FreeBSD:16:*; do mv "$d" "$(echo "$d" | sed 's/:/-/g')"; done
            cp -R /usr/obj/usr/src/repo/. /home/runner/work/ykla.github.io/ykla.github.io/pages-root/

      - name: ä¸Šä¼ ä¸­é—´æ„å»ºäº§ç‰© (${{ matrix.target }})
        uses: actions/upload-artifact@v6
        with:
          name: freebsd-${{ matrix.target }}
          path: pages-root/
          include-hidden-files: true

  pages:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        run: |
          mkdir -p pages-root
          
      - name: ä¸‹è½½ amd64 æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v7
        with:
          name: freebsd-amd64
          path: pages-root

#      - name: ä¸‹è½½ aarch64 æ„å»ºäº§ç‰©
#        uses: actions/download-artifact@v7
#        with:
#          name: freebsd-aarch64
#          path: pages-root

#      - name: ä¸‹è½½ riscv64 æ„å»ºäº§ç‰©
#        uses: actions/download-artifact@v7
#        with:
#          name: freebsd-riscv64
#          path: pages-root

      - name: ç”Ÿæˆç´¢å¼•æ–‡ä»¶
        run: |
          export TZ=Asia/Shanghai

          generate_index_recursive() {
              DIR="$1"                     # å½“å‰ç›®å½•
              REL_PATH="${2:-}"             # ç›¸å¯¹äº pages-root çš„è·¯å¾„ï¼Œç”¨äºæ ‡é¢˜å’Œé“¾æ¥
              OUTPUT="$DIR/index.html"
              BUILD_TIME="$(date '+%Y-%m-%d %H:%M:%S')"  # ä¸œå…«åŒºæ—¶é—´
          
              {
                echo '<!DOCTYPE html>'
                echo '<html lang="zh-CN">'
                echo '<head>'
                echo '  <meta charset="UTF-8">'
                echo '  <meta name="viewport" content="width=device-width, initial-scale=1">'
                echo "  <title>Index of /${REL_PATH}</title>"
                echo '  <style>'
                echo '    body { font-family: monospace; background:#fff; color:#000; }'
                echo '    a { color:#00e; text-decoration:none; }'
                echo '    a:hover { text-decoration:underline; }'
                echo '    table { border-collapse:collapse; }'
                echo '    th, td { padding:4px 12px; text-align:left; }'
                echo '    th { border-bottom:1px solid #000; }'
                echo '  </style>'
                echo '</head>'
                echo '<body>'
                echo '<h1>FreeBSD ä¸­æ–‡ç¤¾åŒº pkgbase é•œåƒç«™ï¼ˆå·²ç§»é™¤è°ƒè¯•é€‰é¡¹ std.debugï¼‰</h1>'
                echo '<p>æœ¬ç«™æ‰€æœ‰æ—¶é—´å‡ä¸ºåŒ—äº¬æ—¶é—´ï¼šåˆ†åˆ«åœ¨æ¯æ—¥å‡Œæ™¨ 1 æ—¶ã€ä¸Šåˆ 9 æ—¶ã€å‚æ™š 5 æ—¶æ‹‰å– freebsd-src çš„ main åˆ†æ”¯ï¼ˆCURRENTï¼‰è¿›è¡Œæ„å»º</p>'
                echo '<h3>å½“å‰æ„å»ºæäº¤ä¿¡æ¯</h3>'
                echo '<pre>'
                sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' githead.txt
                echo '<pre style="background:#f6f6f6; padding:12px; border:1px solid #ccc;">'
                echo "<h2>Index of /${REL_PATH}</h2>"
                echo '<table>'
                echo '<tr><th>æ–‡ä»¶å</th><th>æœ€åå˜åŠ¨æ—¶é—´ï¼ˆUTC+8ï¼‰</th><th>å¤§å°</th></tr>'
                if [ "$REL_PATH" != "" ]; then
                  echo '<tr><td><a href="../index.html">../</a></td><td></td><td></td></tr>'
                fi
                for f in "$DIR"/*; do
                  NAME=$(basename "$f")
                  [[ "$NAME" = "index.html" || "$NAME" = "githead.txt" ]] && continue # æ’é™¤è‡ªå·±
          
                  if [ -d "$f" ]; then
                              MTIME=$(date -r "$f" '+%Y-%m-%d %H:%M:%S')
                    echo "<tr><td><a href=\"$NAME/index.html\">$NAME/</a></td><td>$MTIME</td><td>-</td></tr>"
                  else
                    SIZE=$(du -h "$f" | cut -f1)
                    MTIME=$(date -r "$f" '+%Y-%m-%d %H:%M:%S')
                    echo "<tr><td><a href=\"$NAME\">$NAME</a></td><td>$MTIME</td><td>$SIZE</td></tr>"
                  fi
                done
                echo '</table>'
                echo "<hr><p>é¡µé¢ç”Ÿæˆæ—¶é—´: $BUILD_TIME</p>"
                echo '<p>FreeBSD ä¸­æ–‡ç¤¾åŒºèµåŠ©</p>'
                echo '</body></html>'
              } > "$OUTPUT"

              for sub in "$DIR"/*/; do
                [ -d "$sub" ] || continue
                SUB_NAME=$(basename "$sub")
                SUB_REL_PATH="${REL_PATH}${SUB_NAME}/"
                generate_index_recursive "$sub" "$SUB_REL_PATH"
              done
          }
          generate_index_recursive "pages-root"
          
      - name: ä¸Šä¼  Pages Artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: pages-root

#      - name: å¤åˆ¶ artifact åˆ°æœåŠ¡å™¨
#        uses: appleboy/scp-action@v1
#        with:
#          host: ${{ secrets.HOST }}
#          username: ${{ secrets.USERNAME }}
#          password: ${{ secrets.PASSWORD }}
#          port: ${{ secrets.PORT }}
#          source: pages-root/*
#          target: ${{ secrets.HTML }}
#          rm: true

  deploy:
    needs: pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
