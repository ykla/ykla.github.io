name: ðŸ”— æž„å»º pkgbase

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1,9,17 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - amd64
          - aarch64
          - riscv64

    steps:
      - name: æ£€å‡º
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: åˆå§‹åŒ–è¾“å‡ºç›®å½• (${{ matrix.target }})
        run: |
          mkdir -p pages-root

      - name: åœ¨ FreeBSD VM ä¸­æž„å»º (${{ matrix.target }})
        uses: vmactions/freebsd-vm@v1.4.1
        with:
          release: "15.0"
          arch: x86_64
          sync-time: true
          mem: 10240
#          debug-on-error: true
          run: |
            TARGET_ARCH=${{ matrix.target }}

            rm -rf /usr/src/*
            fetch https://github.com/freebsd/freebsd-src/archive/refs/heads/main.tar.gz
            tar -xzf main.tar.gz --strip-components=1 -C /usr/src/
            cd /usr/src/

            case "$TARGET_ARCH" in
              amd64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/amd64/conf/GENERIC || true
                ;;
              aarch64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/arm64/conf/std.arm64 || true
                ;;
              riscv64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/riscv/conf/GENERIC || true
                ;;
            esac

            make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH buildworld
            make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH buildkernel
            make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH packages

            # ç›´æŽ¥å¤åˆ¶åˆ° pages-root
            mkdir -p /home/runner/work/ykla.github.io/ykla.github.io/pages-root 
            for d in /usr/obj/usr/src/repo/FreeBSD:16:*; do mv "$d" "$(echo "$d" | sed 's/:/-/g')"; done
            cp -R /usr/obj/usr/src/repo/. /home/runner/work/ykla.github.io/ykla.github.io/pages-root/

      - name: ä¸Šä¼ ä¸­é—´æž„å»ºäº§ç‰© (${{ matrix.target }})
        uses: actions/upload-artifact@v6
        with:
          name: freebsd-${{ matrix.target }}
          path: pages-root/
          include-hidden-files: true

  pages:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        run: |
          mkdir -p pages-root
          
      - name: ä¸‹è½½ amd64 æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v7
        with:
          name: freebsd-amd64
          path: pages-root

      - name: ä¸‹è½½ aarch64 æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v7
        with:
          name: freebsd-aarch64
          path: pages-root

      - name: ä¸‹è½½ riscv64 æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v7
        with:
          name: freebsd-riscv64
          path: pages-root

      - name: ç”Ÿæˆç´¢å¼•æ–‡ä»¶
        run: |
         BUILD_TIME="$(date -u '+%Y-%m-%d %H:%M:%S UTC')" && cat > pages-root/index.html <<EOF
         <!DOCTYPE html>
         <html lang="zh-CN">
         <head>
             <meta charset="UTF-8">
             <meta name="viewport" content="width=device-width, initial-scale=1">
             <title>Index of /</title>
             <style>
                 body {
                              font-family: monospace;
                     background-color: #ffffff;
                     color: #000000;
                 }
                 a { color: #0000ee; text-decoration: none; }
                 a:hover { text-decoration: underline; }
                 pre { font-size: 14px; line-height: 1.4; }
                 hr { border: none; border-top: 1px solid #000; margin: 10px 0; }
             </style>
         </head>
         <body>
         <h1>Index of /</h1>
         <hr>
         <pre>
         <a href="../">../</a>
         <a href="FreeBSD-16-amd64/">FreeBSD-16-amd64/</a>
         <a href="FreeBSD-16-aarch64/">FreeBSD-16-aarch64/</a>
         <a href="FreeBSD-16-riscv64/">FreeBSD-16-riscv64/</a>

         Generated on: ${BUILD_TIME}
         </pre>
         <hr>
         </body>
         </html>
         EOF

      - name: ä¸Šä¼  Pages Artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: pages-root

  deploy:
    needs: pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
