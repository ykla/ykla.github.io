name: ğŸ”— æ„å»º pkgbase

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch:
          - x86_64
          - aarch64
          - riscv64

    steps:
      - name: æŸ¥çœ‹é…ç½®
        run: |
          date
          uname -r
          free -hg
          pwd

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Build inside FreeBSD VM (${{ matrix.arch }})
        uses: vmactions/freebsd-vm@v1.3.8
        with:
          release: "15.0"
          arch: ${{ matrix.arch }}
          sync-time: true
          mem: 12288
          # æ¡ä»¶ä¼ å‚ï¼šriscv64 ä½¿ç”¨ sync: scpï¼Œå¦åˆ™é»˜è®¤
          sync: ${{ matrix.arch == 'riscv64' && 'scp' || 'true' }}
          run: |
            rm -rf /usr/src/*
            fetch https://github.com/freebsd/freebsd-src/archive/refs/heads/main.tar.gz
            tar -xzf main.tar.gz --strip-components=1 -C /usr/src/
            cd /usr/src/
            echo 'æ³¨é‡Š amd64 ä¸­çš„å¼€å‘åŠŸèƒ½'
            grep -n 'include "std.debug"' /usr/src/sys/amd64/conf/GENERIC
            sed -i '' 's/^include "std.debug"/#include "std.debug"/' /usr/src/sys/amd64/conf/GENERIC
            echo 'æ£€æŸ¥ amd64 ä¸­çš„å¼€å‘åŠŸèƒ½æ˜¯å¦è¢«æˆåŠŸæ³¨é‡Š'
            grep -n '^#include "std.debug"' /usr/src/sys/amd64/conf/GENERIC
            echo 'æ³¨é‡Š arm64 ä¸­çš„å¼€å‘åŠŸèƒ½'
            grep -n 'include "std.debug"' /usr/src/sys/arm64/conf/std.arm64
            sed -i '' 's/^include "std.debug"/#include "std.debug"/' /usr/src/sys/arm64/conf/std.arm64
            echo 'æ£€æŸ¥ arm64 ä¸­çš„å¼€å‘åŠŸèƒ½æ˜¯å¦è¢«æˆåŠŸæ³¨é‡Š'
            grep -n '^#include "std.debug"' /usr/src/sys/arm64/conf/std.arm64
            echo 'æ³¨é‡Š riscv ä¸­çš„å¼€å‘åŠŸèƒ½'
            grep -n 'include "std.debug"' /usr/src/sys/riscv/conf/GENERIC
            sed -i '' 's/^include "std.debug"/#include "std.debug"/' /usr/src/sys/riscv/conf/GENERIC
            echo 'æ£€æŸ¥ armriscv64 ä¸­çš„å¼€å‘åŠŸèƒ½æ˜¯å¦è¢«æˆåŠŸæ³¨é‡Š'
            grep -n '^#include "std.debug"' /usr/src/sys/riscv/conf/GENERIC
            echo 'å¼€å§‹æ„å»ºä¸–ç•Œ'
            make -s -j5 buildworld
            echo 'å¼€å§‹æ„å»ºå†…æ ¸'
            make -s -j5 buildkernel
            echo 'å¼€å§‹æ„å»ºè½¯ä»¶åŒ…'
            make -s -j5 packages
            DEST=/home/runner/work/ykla.github.io/ykla.github.io/pages-root/freebsd-base
            mkdir -p "$DEST"
            cp -R -p /usr/obj/usr/src/repo/. "$DEST/"

      - name: æŸ¥çœ‹æ„å»ºäº§ç‰©
        run: |
          ls -al pages-root/
          du -hs pages-root/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          path: pages-root
