name: ğŸ”— æ„å»º pkgbase

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1,9,17 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pkgbase
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - amd64
#          - aarch64
#          - riscv64

    steps:
      - name: æ£€å‡º
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: åˆå§‹åŒ–è¾“å‡ºç›®å½• (${{ matrix.target }})
        run: |
          mkdir -p pages-root

      - name: åœ¨ FreeBSD VM ä¸­æ„å»º (${{ matrix.target }})
        uses: vmactions/freebsd-vm@v1.4.2
        with:
          release: "15.0"
          arch: x86_64
          sync-time: true
          mem: 8192
#          debug-on-error: true
          run: |
            export TZ=Asia/Shanghai
            TARGET_ARCH=${{ matrix.target }}
            pkg update -f  # æ³¨æ„ï¼Œriscv é»˜è®¤æ—  pkg æº
            pkg ins -y git 
            [ -d /usr/src ] || mkdir -p /usr/src && rm -rf /usr/src/*
            cd /usr/src
            git config --global advice.defaultBranchName false
            git clone --depth 1 --branch main https://git.freebsd.org/src.git /usr/src

            case "$TARGET_ARCH" in
              amd64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/amd64/conf/GENERIC || true
                ;;
              aarch64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/arm64/conf/std.arm64 || true
                ;;
              riscv64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/riscv/conf/GENERIC || true
                ;;
            esac

            #make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH buildworld
            #make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH buildkernel
            #make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH packages
            # ç›´æ¥å¤åˆ¶åˆ° pages-root
            mkdir -p /home/runner/work/ykla.github.io/ykla.github.io/pages-root 
            #for d in /usr/obj/usr/src/repo/FreeBSD:16:*; do mv "$d" "$(echo "$d" | sed 's/:/-/g')"; done
            #cp -R /usr/obj/usr/src/repo/. /home/runner/work/ykla.github.io/ykla.github.io/pages-root/
            cd /usr/src
            TZ=Asia/Shanghai git log -1 --pretty=format:"å“ˆå¸Œï¼š%H%nä½œè€…ï¼š%an <%ae>%næäº¤è€…ï¼š%cn <%ce>%næäº¤æ—¶é—´ï¼š%cd%næäº¤ä¿¡æ¯ï¼š%n%n%B" --date=format:"%Y-%m-%d %H:%M:%S %z" > /home/runner/work/ykla.github.io/ykla.github.io/pages-root/commit.txt
            ls -al /home/runner/work/ykla.github.io/ykla.github.io/pages-root/
            du -sh /home/runner/work/ykla.github.io/ykla.github.io/pages-root/
            
      - name: ä¸Šä¼ ä¸­é—´æ„å»ºäº§ç‰© (${{ matrix.target }})
        uses: actions/upload-artifact@v6
        with:
          name: freebsd-${{ matrix.target }}
          path: pages-root/
          include-hidden-files: true

  pages:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        run: |
          mkdir -p pages-root
          
      - name: ä¸‹è½½ amd64 æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v7
        with:
          name: freebsd-amd64
          path: pages-root

#      - name: ä¸‹è½½ aarch64 æ„å»ºäº§ç‰©
#        uses: actions/download-artifact@v7
#        with:
#          name: freebsd-aarch64
#          path: pages-root

#      - name: ä¸‹è½½ riscv64 æ„å»ºäº§ç‰©
#        uses: actions/download-artifact@v7
#        with:
#          name: freebsd-riscv64
#          path: pages-root

      - name: ç”Ÿæˆç´¢å¼•æ–‡ä»¶
        run: |
          export TZ=Asia/Shanghai
          pwd
          ls -al
          ls -al */*

          generate_index_recursive() {
            DIR="$1"
            REL_PATH="${2:-}"
            OUTPUT="$DIR/index.html"
            BUILD_TIME="$(date '+%Y-%m-%d %H:%M:%S')"

          {
          echo '<!DOCTYPE html>'
          echo '<html lang="zh-CN">'
          echo '<head>'
          echo '  <meta charset="UTF-8">'
          echo '  <meta name="viewport" content="width=device-width, initial-scale=1">'
          echo "  <title>Index of /${REL_PATH}</title>"
          echo '  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">'
          echo '  <style>'
          echo '    :root {'
          echo '      --primary-color: #000000;'
          echo '      --secondary-color: #f8f8f8;'
          echo '      --accent-color: #333333;'
          echo '      --text-color: #333333;'
          echo '      --light-text: #666666;'
          echo '      --border-color: #e0e0e0;'
          echo '      --card-bg: #ffffff;'
          echo '      --shadow: 0 4px 12px rgba(0,0,0,0.08);'
          echo '    }'
          echo '    * { margin:0; padding:0; box-sizing:border-box; }'
          echo '    body {'
          echo '      font-family: "PingFang SC","Hiragino Sans GB","Microsoft YaHei UI","Microsoft YaHei","Noto Sans CJK SC",sans-serif;'
          echo '      color:var(--text-color);'
          echo '      line-height:1.6;'
          echo '      background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);'
          echo '    }'
          echo '    .container { max-width:1200px; margin:0 auto; padding:20px; }'
          echo '    header { margin-bottom:20px; }'
          echo '    h1 { font-size:1.8rem; margin-bottom:10px; }'
          echo '    h2 { margin-bottom:20px; border-bottom:2px solid var(--secondary-color); padding-bottom:10px; }'
          echo '    p { font-size:1rem; color:#555; margin-top:10px; }'
          echo '    .info-card {'
          echo '      background: var(--card-bg);'
          echo '      padding:20px;'
          echo '      border-radius:12px;'
          echo '      box-shadow:var(--shadow);'
          echo '      margin-bottom:30px;'
          echo '      transition: transform 0.2s;'
          echo '    }'
          echo '    .info-card:hover { transform: translateY(-4px); }'
          echo '    .commit-info {'
          echo '      background:#1f883d;'
          echo '      color:white;'
          echo '      padding:15px;'
          echo '      border-radius:8px;'
          echo '      border-left:4px solid #1a7333;'
          echo '      overflow:auto;'
          echo '      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;'
          echo '      font-size:0.9rem;'
          echo '      white-space:pre-wrap;'
          echo '      word-break:break-word;'
          echo '    }'
          echo '    table {'
          echo '      width:100%;'
          echo '      border-collapse:collapse;'
          echo '      background:#fff;'
          echo '      border-radius:8px;'
          echo '      overflow:hidden;'
          echo '      box-shadow:0 2px 8px rgba(0,0,0,0.05);'
          echo '      margin-bottom:20px;'
          echo '    }'
          echo '    th, td { padding:12px; text-align:left; }'
          echo '    th { background:#f1f3f5; cursor:pointer; }'
          echo '    th.asc::after { content:" â–²"; }'
          echo '    th.desc::after { content:" â–¼"; }'
          echo '    tr:hover td { background:#f8f9fa; }'
          echo '    footer { text-align:center; margin-top:40px; font-size:0.9rem; color:#555; }'
          echo '  </style>'
          echo '</head>'
          echo '<body>'
          echo '<div class="container">'

          # Header
          echo '<header>'
          echo '<h1 style="display:flex;align-items:center;gap:12px;">'
          echo '  <img src="https://www.bsdcn.org/image/avatar.jpg" alt="BSDCN Logo" style="width:42px;height:42px;border-radius:8px;">'
          echo '  <span>FreeBSD ä¸­æ–‡ç¤¾åŒº pkgbase é•œåƒç«™</span>'
          echo '</h1>'
          echo '<p>æœ¬ç«™æ‰€æœ‰æ—¶é—´å‡ä¸ºåŒ—äº¬æ—¶é—´ï¼šæ¯æ—¥å‡Œæ™¨ 1 æ—¶ã€ä¸Šåˆ 9 æ—¶ã€å‚æ™š 5 æ—¶æ‹‰å– freebsd-src çš„ main åˆ†æ”¯ï¼ˆCURRENTï¼‰è¿›è¡Œæ„å»ºã€‚<br>'
          echo 'æœ¬ç«™ pkgbase å·²ç§»é™¤è°ƒè¯•é€‰é¡¹ std.debugã€‚æœ¬é¡¹ç›®æ„å»ºæºä»£ç ï¼š<a href="https://github.com/ykla/ykla.github.io" target="_blank">GitHub</a></p>'
          echo '</header>'

          # æäº¤ä¿¡æ¯å¡ç‰‡
          echo '<div class="info-card">'
          echo '<h3>å½“å‰æ„å»ºæäº¤ä¿¡æ¯</h3>'
          echo '<div class="commit-info">'
          sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' /home/runner/work/ykla.github.io/ykla.github.io/pages-root/commit.txt \
            | sed -E 's|(https?://[^ ]+)|<a href="\1" target="_blank" style="color:white;text-decoration:underline;">\1</a>|g; s|å“ˆå¸Œï¼š([0-9a-f]{7,40})|å“ˆå¸Œï¼š<a href="https://github.com/freebsd/freebsd-src/commit/\1" target="_blank" style="color:white;text-decoration:underline;">\1</a>|g'
                    echo '</div>'
          echo '</div>'

          # æ–‡ä»¶ç´¢å¼•è¡¨æ ¼
          echo '<div class="info-card">'
          echo "<h2>Index of /${REL_PATH}</h2>"
          echo '<table id="fileTable">'
          echo '<tr><th>æ–‡ä»¶å</th><th>æœ€åå˜åŠ¨æ—¶é—´ï¼ˆUTC+8ï¼‰</th><th>å¤§å°</th></tr>'

          if [ "$REL_PATH" != "" ]; then
            echo '<tr><td><a href="../index.html">../</a></td><td></td><td></td></tr>'
          fi

          for NAME in $(ls -1 "$DIR" | sort); do
            f="$DIR/$NAME"
            [[ "$NAME" = "index.html" || "$NAME" = "commit.txt" ]] && continue

            MTIME=$(date -r "$f" '+%Y-%m-%d %H:%M:%S')

            if [ -d "$f" ]; then
              SIZE=$(find "$f" -type f ! -name "index.html" ! -name "commit.txt" -exec du -k {} + 2>/dev/null | awk '{sum+=$1} END {if(sum>=1048576)printf "%.2fG",sum/1048576; else if(sum>=1024)printf "%.2fM",sum/1024; else printf "%.2fK",sum}')
              [ -z "$SIZE" ] && SIZE="0K"
              echo "<tr><td><a href=\"$NAME/index.html\">$NAME/</a></td><td>$MTIME</td><td>$SIZE</td></tr>"
            else
              SIZE=$(du -sh "$f" | cut -f1)
              echo "<tr><td><a href=\"$NAME\">$NAME</a></td><td>$MTIME</td><td>$SIZE</td></tr>"
            fi
          done

          echo '</table>'
          echo '</div>'

          # Footer
          echo '<footer>'
          echo "<p>é¡µé¢ç”Ÿæˆæ—¶é—´: $BUILD_TIME</p>"
          echo '<p>Â© FreeBSD ä¸­æ–‡ç¤¾åŒº 2026</p>'
          echo '</footer>'

          echo '</div>'

          # è¡¨æ ¼æ’åºè„šæœ¬
          echo '<script>'
          echo 'document.querySelectorAll("th").forEach((header, index) => {'
          echo '  header.addEventListener("click", () => {'
          echo '    const table = document.getElementById("fileTable");'
          echo '    const rows = Array.from(table.rows).slice(1);'
          echo '    const asc = header.classList.toggle("asc");'
          echo '    header.classList.toggle("desc", !asc);'
          echo '    rows.sort((a,b)=>{'
          echo '      let A=a.cells[index].innerText.trim();'
          echo '      let B=b.cells[index].innerText.trim();'
          echo '      let numA=parseFloat(A.replace(/[^\d.]/g,""));'
          echo '      let numB=parseFloat(B.replace(/[^\d.]/g,""));'
          echo '      if(!isNaN(numA)&&!isNaN(numB)) return asc?numA-numB:numB-numA;'
          echo '      return asc?A.localeCompare(B):B.localeCompare(A);'
          echo '    });'
          echo '    rows.forEach(r=>table.appendChild(r));'
          echo '  });'
          echo '});'
          echo '</script>'

          echo '</body>'
          echo '</html>'

          } > "$OUTPUT"

          # é€’å½’ç”Ÿæˆå­ç›®å½•
          for sub in "$DIR"/*/; do
            [ -d "$sub" ] || continue
            SUB_NAME=$(basename "$sub")
            SUB_REL_PATH="${REL_PATH}${SUB_NAME}/"
            generate_index_recursive "$sub" "$SUB_REL_PATH"
          done
          }

          # è°ƒç”¨å‡½æ•°
          generate_index_recursive "pages-root"

      - name: ä¸Šä¼  Pages Artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: pages-root

#      - name: å¤åˆ¶ artifact åˆ°æœåŠ¡å™¨
#        uses: appleboy/scp-action@v1
#        with:
#          host: ${{ secrets.HOST }}
#          username: ${{ secrets.USERNAME }}
#          password: ${{ secrets.PASSWORD }}
#          port: ${{ secrets.PORT }}
#          source: pages-root/*
#          target: ${{ secrets.HTML }}
#          rm: true

  deploy:
    needs: pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
