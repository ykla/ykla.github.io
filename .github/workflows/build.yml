name: üîó ÊûÑÂª∫ pkgbase

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1,9,17 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pkgbase
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - amd64
#          - aarch64
#          - riscv64

    steps:
      - name: Ê£ÄÂá∫
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: ÂàùÂßãÂåñËæìÂá∫ÁõÆÂΩï (${{ matrix.target }})
        run: |
          mkdir -p pages-root

      - name: Âú® FreeBSD VM ‰∏≠ÊûÑÂª∫ (${{ matrix.target }})
        uses: vmactions/freebsd-vm@v1.4.2
        with:
          release: "15.0"
          arch: x86_64
          sync-time: true
          mem: 8192
#          debug-on-error: true
          run: |
            export TZ=Asia/Shanghai
            TARGET_ARCH=${{ matrix.target }}
            pkg update -f  # Ê≥®ÊÑèÔºåriscv ÈªòËÆ§Êó† pkg Ê∫ê
            pkg ins -y git 
            [ -d /usr/src ] || mkdir -p /usr/src && rm -rf /usr/src/*
            cd /usr/src
            git config --global advice.defaultBranchName false
            git clone --depth 1 --branch main https://git.freebsd.org/src.git /usr/src

            case "$TARGET_ARCH" in
              amd64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/amd64/conf/GENERIC || true
                ;;
              aarch64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/arm64/conf/std.arm64 || true
                ;;
              riscv64)
                sed -i '' 's/^include "std.debug"/#include "std.debug"/' sys/riscv/conf/GENERIC || true
                ;;
            esac

            #make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH buildworld
            #make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH buildkernel
            #make -s -j$(sysctl -n hw.ncpu) TARGET_ARCH=$TARGET_ARCH packages
            # Áõ¥Êé•Â§çÂà∂Âà∞ pages-root
            mkdir -p /home/runner/work/ykla.github.io/ykla.github.io/pages-root 
            #for d in /usr/obj/usr/src/repo/FreeBSD:16:*; do mv "$d" "$(echo "$d" | sed 's/:/-/g')"; done
            #cp -R /usr/obj/usr/src/repo/. /home/runner/work/ykla.github.io/ykla.github.io/pages-root/
            cd /usr/src
            TZ=Asia/Shanghai git log -1 --pretty=format:"ÂìàÂ∏åÔºö<a href=\"https://github.com/freebsd/freebsd-src/commit/%H\" target=\"_blank\">%h</a>%n‰ΩúËÄÖÔºö%an <%ae>%nÊèê‰∫§ËÄÖÔºö%cn <%ce>%nÊèê‰∫§Êó∂Èó¥Ôºö%cd%nÊèê‰∫§‰ø°ÊÅØÔºö%n%n%B" --date=format:"%Y-%m-%d %H:%M:%S %z"  > /home/runner/work/ykla.github.io/ykla.github.io/pages-root/commit.txt   
            ls -al /home/runner/work/ykla.github.io/ykla.github.io/pages-root/
            du -sh /home/runner/work/ykla.github.io/ykla.github.io/pages-root/
            
      - name: ‰∏ä‰º†‰∏≠Èó¥ÊûÑÂª∫‰∫ßÁâ© (${{ matrix.target }})
        uses: actions/upload-artifact@v6
        with:
          name: freebsd-${{ matrix.target }}
          path: pages-root/
          include-hidden-files: true

  pages:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ‰∏ãËΩΩÊâÄÊúâÊûÑÂª∫‰∫ßÁâ©
        run: |
          mkdir -p pages-root
          
      - name: ‰∏ãËΩΩ amd64 ÊûÑÂª∫‰∫ßÁâ©
        uses: actions/download-artifact@v7
        with:
          name: freebsd-amd64
          path: pages-root

#      - name: ‰∏ãËΩΩ aarch64 ÊûÑÂª∫‰∫ßÁâ©
#        uses: actions/download-artifact@v7
#        with:
#          name: freebsd-aarch64
#          path: pages-root

#      - name: ‰∏ãËΩΩ riscv64 ÊûÑÂª∫‰∫ßÁâ©
#        uses: actions/download-artifact@v7
#        with:
#          name: freebsd-riscv64
#          path: pages-root

      - name: ÁîüÊàêÁ¥¢ÂºïÊñá‰ª∂
        run: |
          export TZ=Asia/Shanghai
          pwd
          ls -al
          ls -al */*
        
          generate_index_recursive() {
            DIR="$1"
            REL_PATH="${2:-}"
            OUTPUT="$DIR/index.html"
            BUILD_TIME="$(date '+%Y-%m-%d %H:%M:%S')"

           {
                echo '<!DOCTYPE html>'
                echo '<html lang="zh-CN">'
                echo '<head>'
                echo '  <meta charset="UTF-8">'
                echo '  <meta name="viewport" content="width=device-width, initial-scale=1">'
                echo "  <title>Index of /${REL_PATH}</title>"
                echo '  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">'
                echo '  <style>'
                echo '    :root {'
                echo '      --primary-color: #000000;'
                echo '      --secondary-color: #f8f8f8;'
                echo '      --accent-color: #333333;'
                echo '      --text-color: #333333;'
                echo '      --light-text: #666666;'
                echo '      --border-color: #e0e0e0;'
                echo '      --success-color: #1f883d;'
                echo '      --card-bg: #ffffff;'
                echo '      --header-bg: #000000;'
                echo '      --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);'
                echo '      --gradient-bg: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);'
                echo '    }'
                echo '    * {'
                echo '      margin: 0;'
                echo '      padding: 0;'
                echo '      box-sizing: border-box;'
                echo '    }'
                echo '    body {'
                echo '      font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", "Noto Sans CJK SC", sans-serif;'
                echo '      background: var(--gradient-bg);'
                echo '      color: var(--text-color);'
                echo '      line-height: 1.6;'
                echo '    }'
                echo '    .container {'
                echo '      max-width: 1200px;'
                echo '      margin: 0 auto;'
                echo '      padding: 20px;'
                echo '    }'
                echo '    header {'
                echo '      background: none;'
                echo '      color: var(--text-color);'
                echo '      padding: 30px 0;'
                echo '      margin-bottom: 30px;'
                echo '      border-radius: 0;'
                echo '      box-shadow: none;'
                echo '      text-align: center;'
                echo '    }'
                echo '    header .container {'
                echo '      padding: 0 30px;'
                echo '    }'
                echo '    h1 {'
                echo '      font-size: 2.2rem;'
                echo '      margin-bottom: 15px;'
                echo '      font-weight: 700;'
                echo '      letter-spacing: -0.5px;'
                echo '    }'
                echo '    h2 {'
                echo '      font-size: 1.8rem;'
                echo '      margin-bottom: 20px;'
                echo '      color: var(--primary-color);'
                echo '      padding-bottom: 12px;'
                echo '      border-bottom: 2px solid var(--secondary-color);'
                echo '      font-weight: 600;'
                echo '    }'
                echo '    h3 {'
                echo '      font-size: 1.4rem;'
                echo '      margin-bottom: 15px;'
                echo '      color: var(--text-color);'
                echo '      font-weight: 600;'
                echo '    }'
                echo '    p {'
                echo '      margin-bottom: 15px;'
                echo '      color: var(--light-text);'
                echo '      line-height: 1.7;'
                echo '    }'
                echo '    a {'
                echo '      color: var(--primary-color);'
                echo '      text-decoration: none;'
                echo '      transition: all 0.3s ease;'
                echo '      position: relative;'
                echo '    }'
                echo '    a:hover {'
                echo '      color: var(--accent-color);'
                echo '      text-decoration: none;'
                echo '    }'
                echo '    a::after {'
                echo '      content: \'\';'
                echo '      position: absolute;'
                echo '      width: 0;'
                echo '      height: 2px;'
                echo '      bottom: -2px;'
                echo '      left: 0;'
                echo '      background-color: var(--primary-color);'
                echo '      transition: width 0.3s ease;'
                echo '    }'
                echo '    a:hover::after {'
                echo '      width: 100%;'
                echo '    }'
                echo '    .info-card {'
                echo '      background: var(--card-bg);'
                echo '      padding: 30px;'
                echo '      border-radius: 12px;'
                echo '      box-shadow: var(--shadow);'
                echo '      margin-bottom: 30px;'
                echo '      transition: transform 0.3s ease, box-shadow 0.3s ease;'
                echo '      border: 1px solid var(--border-color);'
                echo '    }'
                echo '    .info-card:hover {'
                echo '      transform: translateY(-8px);'
                echo '      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);'
                echo '    }'
                echo '    .commit-info {'
                echo '      background: #1f883d;'
                echo '      color: white;'
                echo '      padding: 25px;'
                echo '      border-radius: 10px;'
                echo '      border-left: 4px solid #1a7333;'
                echo '      overflow: auto;'
                echo '      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;'
                echo '      font-size: 0.95rem;'
                echo '      line-height: 1.6;'
                echo '      box-shadow: 0 4px 12px rgba(31, 136, 61, 0.2);'
                echo '      transition: transform 0.3s ease;'
                echo '    }'
                echo '    .commit-info:hover {'
                echo '      transform: translateX(5px);'
                echo '    }'
                echo '    .table-wrapper {'
                echo '      background: var(--card-bg);'
                echo '      border-radius: 12px;'
                echo '      box-shadow: var(--shadow);'
                echo '      overflow: hidden;'
                echo '      margin-bottom: 30px;'
                echo '      border: 1px solid var(--border-color);'
                echo '    }'
                echo '    table {'
                echo '      width: 100%;'
                echo '      border-collapse: collapse;'
                echo '    }'
                echo '    th {'
                echo '      background: var(--secondary-color);'
                echo '      padding: 18px 20px;'
                echo '      text-align: left;'
                echo '      font-weight: 600;'
                echo '      color: var(--text-color);'
                echo '      border-bottom: 2px solid var(--primary-color);'
                echo '      font-size: 1rem;'
                echo '      cursor: pointer;'
                echo '      user-select: none;'
                echo '      position: relative;'
                echo '    }'
                echo '    th:hover {'
                echo '      background: #f0f0f0;'
                echo '    }'
                echo '    th::after {'
                echo '      content: "";'
                echo '      position: absolute;'
                echo '      right: 10px;'
                echo '      top: 50%;'
                echo '      transform: translateY(-50%);'
                echo '      border-width: 5px 5px 0;'
                echo '      border-style: solid;'
                echo '      border-color: transparent transparent var(--light-text);'
                echo '      opacity: 0.5;'
                echo '      transition: opacity 0.3s ease;'
                echo '    }'
                echo '    th:hover::after {'
                echo '      opacity: 1;'
                echo '    }'
                echo '    th.ascending::after {'
                echo '      border-width: 0 5px 5px;'
                echo '      border-color: var(--primary-color) transparent transparent;'
                echo '      opacity: 1;'
                echo '    }'
                echo '    th.descending::after {'
                echo '      border-width: 5px 5px 0;'
                echo '      border-color: var(--primary-color) transparent transparent;'
                echo '      opacity: 1;'
                echo '    }'
                echo '    td {'
                echo '      padding: 15px 20px;'
                echo '      border-bottom: 1px solid var(--border-color);'
                echo '      transition: background 0.2s ease, transform 0.2s ease;'
                echo '    }'
                echo '    tr:hover td {'
                echo '      background: var(--secondary-color);'
                echo '      transform: translateX(5px);'
                echo '    }'
                echo '    tr:last-child td {'
                echo '      border-bottom: none;'
                echo '    }'
                echo '    .file-icon {'
                echo '      margin-right: 10px;'
                echo '      color: var(--primary-color);'
                echo '      font-size: 1.1rem;'
                echo '    }'
                echo '    .dir-icon {'
                echo '      margin-right: 10px;'
                echo '      color: var(--success-color);'
                echo '      font-size: 1.1rem;'
                echo '    }'
                echo '    footer {'
                echo '      background: var(--card-bg);'
                echo '      padding: 30px 0;'
                echo '      margin-top: 50px;'
                echo '      border-radius: 12px;'
                echo '      box-shadow: var(--shadow);'
                echo '      text-align: center;'
                echo '      border: 1px solid var(--border-color);'
                echo '    }'
                echo '    footer p {'
                echo '      color: var(--light-text);'
                echo '      font-size: 0.95rem;'
                echo '      margin-bottom: 10px;'
                echo '    }'
                echo '    footer p:last-child {'
                echo '      margin-bottom: 0;'
                echo '    }'
                echo '    .logo-container {'
                echo '      display: flex;'
                echo '      align-items: center;'
                echo '      justify-content: center;'
                echo '      margin-bottom: 20px;'
                echo '    }'
                echo '    .logo-container img {'
                echo '      width: 50px;'
                echo '      height: 50px;'
                echo '      margin-right: 15px;'
                echo '      border-radius: 8px;'
                echo '      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);'
                echo '      transition: transform 0.3s ease;'
                echo '    }'
                echo '    .logo-container img:hover {'
                echo '      transform: scale(1.05);'
                echo '    }'
                echo '    .header-content {'
                echo '      max-width: 800px;'
                echo '      margin: 0 auto;'
                echo '    }'

                echo '    @media (max-width: 768px) {'
                echo '      .container {'
                echo '        padding: 15px;'
                echo '      }'
                echo '      header .container {'
                echo '        padding: 0 20px;'
                echo '      }'
                echo '      h1 {'
                echo '        font-size: 1.8rem;'
                echo '      }'
                echo '      h2 {'
                echo '        font-size: 1.5rem;'
                echo '      }'
                echo '      h3 {'
                echo '        font-size: 1.3rem;'
                echo '      }'
                echo '      .info-card {'
                echo '        padding: 25px;'
                echo '      }'
                echo '      th, td {'
                echo '        padding: 12px 15px;'
                echo '        font-size: 0.9rem;'
                echo '      }'
                echo '      .logo-container img {'
                echo '        width: 40px;'
                echo '        height: 40px;'
                echo '      }'
                echo '    }'

                echo '  </style>'
                echo '  <script>'
                echo '    document.addEventListener("DOMContentLoaded", function() {'
                echo '      const table = document.querySelector("table");'
                echo '      const headers = table.querySelectorAll("th");'
                echo '      '
                echo '      headers.forEach(header => {'
                echo '        header.addEventListener("click", function() {'
                echo '          const columnIndex = Array.from(headers).indexOf(this);'
                echo '          const isAscending = this.classList.contains("ascending");'
                echo '          '
                echo '          // ÁßªÈô§ÊâÄÊúâÊéíÂ∫èÁä∂ÊÄÅ'
                echo '          headers.forEach(h => {'
                echo '            h.classList.remove("ascending", "descending");'
                echo '          });'
                echo '          '
                echo '          // ËÆæÁΩÆÂΩìÂâçÊéíÂ∫èÁä∂ÊÄÅ'
                echo '          this.classList.toggle("ascending", !isAscending);'
                echo '          this.classList.toggle("descending", isAscending);'
                echo '          '
                echo '          // ÊéíÂ∫èË°®Ê†º'
                echo '          sortTable(table, columnIndex, !isAscending);'
                echo '        });'
                echo '      });'
                echo '      '
                echo '      function sortTable(table, columnIndex, ascending) {'
                echo '        const tbody = table.querySelector("tbody") || table.querySelector("tr").parentNode;'
                echo '        const rows = Array.from(tbody.querySelectorAll("tr"));'
                echo '        '
                echo '        rows.sort((a, b) => {'
                echo '          const aValue = a.querySelectorAll("td")[columnIndex].textContent.trim();'
                echo '          const bValue = b.querySelectorAll("td")[columnIndex].textContent.trim();'
                echo '          '
                echo '          // Â§ÑÁêÜÊï∞Â≠óÂíåÊó•Êúü'
                echo '          if (!isNaN(Date.parse(aValue)) && !isNaN(Date.parse(bValue))) {'
                echo '            return ascending ? new Date(aValue) - new Date(bValue) : new Date(bValue) - new Date(aValue);'
                echo '          } else if (!isNaN(parseFloat(aValue)) && !isNaN(parseFloat(bValue))) {'
                echo '            return ascending ? parseFloat(aValue) - parseFloat(bValue) : parseFloat(bValue) - parseFloat(aValue);'
                echo '          } else {'
                echo '            return ascending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);'
                echo '          }'
                echo '        });'
                echo '        '
                echo '        // ÈáçÊñ∞ÊèíÂÖ•ÊéíÂ∫èÂêéÁöÑË°å'
                echo '        rows.forEach(row => tbody.appendChild(row));'
                echo '      }'
                echo '    });'
                echo '  </script>'
                echo '</head>'
                echo '<body>'
                echo '<div class="container">'
                echo '  <header>'
                echo '    <div class="container">'
                echo '      <div class="header-content">'
                echo '        <div class="logo-container">'
                echo '          <img src="https://www.bsdcn.org/image/avatar.jpg" alt="BSDCN Logo">'
                echo '          <h1>FreeBSD ‰∏≠ÊñáÁ§æÂå∫ pkgbase ÈïúÂÉèÁ´ô</h1>'
                echo '        </div>'
                echo '        <p>Êú¨Á´ôÊâÄÊúâÊó∂Èó¥Âùá‰∏∫Âåó‰∫¨Êó∂Èó¥ÔºöÂàÜÂà´Âú®ÊØèÊó•ÂáåÊô® 1 Êó∂„ÄÅ‰∏äÂçà 9 Êó∂„ÄÅÂÇçÊôö 5 Êó∂ÊãâÂèñ freebsd-src ÁöÑ main ÂàÜÊîØÔºàCURRENTÔºâËøõË°åÊûÑÂª∫</p>'
                echo '        <p>Êú¨Á´ô pkgbase Â∑≤ÁßªÈô§Ë∞ÉËØïÈÄâÈ°π std.debug„ÄÇÊú¨È°πÁõÆÊûÑÂª∫Ê∫ê‰ª£Á†ÅÔºö<a href="https://github.com/ykla/ykla.github.io" target="_blank">https://github.com/ykla/ykla.github.io</a></p>'
                echo '      </div>'
                echo '    </div>'
                echo '  </header>'

                echo '  <div class="info-card">'
                echo '    <h3><i class="fas fa-code-branch"></i> ÂΩìÂâçÊûÑÂª∫Êèê‰∫§‰ø°ÊÅØ</h3>'
                echo '    <div class="commit-info">'
          sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/\n/<br>/g' /home/runner/work/ykla.github.io/ykla.github.io/pages-root/commit.txt
                echo '    </div>'
                echo '  </div>'

                echo '  <div class="info-card">'
                echo "    <h2><i class="fas fa-folder-open"></i> Index of /${REL_PATH}</h2>"
                echo '    <div class="table-wrapper">'
                echo '      <table>'
                echo '        <tr><th><i class="fas fa-file-alt"></i> Êñá‰ª∂Âêç</th><th><i class="fas fa-clock"></i> ÊúÄÂêéÂèòÂä®Êó∂Èó¥ÔºàUTC+8Ôºâ</th><th><i class="fas fa-weight-hanging"></i> Â§ßÂ∞è</th></tr>'

          if [ "$REL_PATH" != "" ]; then
                  echo '        <tr><td><a href="../index.html"><i class="fas fa-level-up-alt"></i> ../</a></td><td></td><td></td></tr>'
          fi

          for f in "$DIR"/*; do
          NAME=$(basename "$f")
          [[ "$NAME" = "index.html" || "$NAME" = "commit.txt" ]] && continue

          MTIME=$(date -r "$f" '+%Y-%m-%d %H:%M:%S')

          if [ -d "$f" ]; then
          # ÁõÆÂΩïÈÄíÂΩíÂ§ßÂ∞èÔºàÊéíÈô§ index.html ‰∏é commit.txtÔºâ
          SIZE=$(find "$f" -type f ! -name "index.html" ! -name "commit.txt" -exec du -k {} + 2>/dev/null | awk '{sum+=$1} END {if(sum>=1024*1024)printf "%.2fG",sum/1024/1024; else if(sum>=1024)printf "%.2fM",sum/1024; else printf "%.2fK",sum}')
          [ -z "$SIZE" ] && SIZE="0K"
                    echo "        <tr><td><a href=\"$NAME/index.html\"><i class=\"fas fa-folder dir-icon\"></i>$NAME/</a></td><td>$MTIME</td><td>$SIZE</td></tr>"
           else
          SIZE=$(du -sh "$f" | cut -f1)
                    echo "        <tr><td><a href=\"$NAME\"><i class=\"fas fa-file file-icon\"></i>$NAME</a></td><td>$MTIME</td><td>$SIZE</td></tr>"
          fi
          done

                echo '      </table>'
                echo '    </div>'
                echo '  </div>'

                echo '  <footer>'
                echo "    <p>È°µÈù¢ÁîüÊàêÊó∂Èó¥: $BUILD_TIME</p>"
                echo '    <p><i class="fas fa-copyright"></i> FreeBSD ‰∏≠ÊñáÁ§æÂå∫ 2026</p>'
                echo '    <p><i class="fas fa-globe"></i> <a href="https://www.bsdcn.org" target="_blank">FreeBSD ‰∏≠ÊñáÁ§æÂå∫</a></p>'
                echo '  </footer>'
                echo '</div>'
                echo '</body>'
                echo '</html>'

          } > "$OUTPUT"

          for sub in "$DIR"/*/; do
                [ -d "$sub" ] || continue
                SUB_NAME=$(basename "$sub")
                SUB_REL_PATH="${REL_PATH}${SUB_NAME}/"
                generate_index_recursive "$sub" "$SUB_REL_PATH"
              done
          }

          generate_index_recursive "pages-root"
      - name: ‰∏ä‰º† Pages Artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: pages-root

#      - name: Â§çÂà∂ artifact Âà∞ÊúçÂä°Âô®
#        uses: appleboy/scp-action@v1
#        with:
#          host: ${{ secrets.HOST }}
#          username: ${{ secrets.USERNAME }}
#          password: ${{ secrets.PASSWORD }}
#          port: ${{ secrets.PORT }}
#          source: pages-root/*
#          target: ${{ secrets.HTML }}
#          rm: true

  deploy:
    needs: pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ÈÉ®ÁΩ≤Âà∞ GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
